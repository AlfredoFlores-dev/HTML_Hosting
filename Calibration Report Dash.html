<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calibration, Potential & Performance — Executive Dashboard (Prototype)</title>
<style>
:root{
  --bg:#0b0f16; --panel:#131a24; --ink:#e8eef7; --muted:#9fb3c8;
  --accent:#4db6ff; --accent2:#75e0a3; --warn:#ffb74d; --danger:#ff6f61; --ok:#66bb6a;
  --grid:#1c2633; --sectionTitle:#c8d6e5; --sectionTitleSize:16px;
  --band-red: rgba(255,111,97,.12); --band-amber: rgba(255,183,77,.12); --band-green: rgba(102,187,106,.12);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI, Roboto, Helvetica, Arial, sans-serif}
.header{padding:20px 28px;border-bottom:1px solid var(--grid);display:flex;align-items:center;gap:18px;flex-wrap:wrap}
.header h1{font-size:20px;margin:0;letter-spacing:.2px}
.badge{font-size:12px;color:var(--bg);background:linear-gradient(135deg,var(--accent),var(--accent2));padding:4px 8px;border-radius:999px}
.controls{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
select,button,input[type=checkbox]{cursor:pointer}
select,button{background:#0f1520;color:var(--ink);border:1px solid var(--grid);border-radius:8px;padding:8px 10px}
.tabs{display:flex;gap:6px;padding:12px 20px;border-bottom:1px solid var(--grid)}
.tab{padding:8px 14px;border-radius:8px;cursor:pointer;color:var(--muted)}
.tab.active{background:var(--panel);color:var(--ink);box-shadow:0 0 0 1px var(--grid) inset}
.container{padding:16px 20px 28px}

/* KPI cards */
.kpis{display:grid;grid-template-columns:repeat(6,minmax(140px,1fr));gap:12px}
.card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px}
.card h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);font-weight:600}
.card .val{font-size:24px;font-weight:700}
.small{font-size:12px;color:var(--muted)}

/* Layout + panels */
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:16px}
.section{grid-column:span 12}
.panel{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:14px}

/* Section headers */
.sectionTitle{margin:0 0 8px 2px;font-size:var(--sectionTitleSize);color:var(--sectionTitle);letter-spacing:.2px;font-weight:600}

/* Tables */
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{padding:10px;border-bottom:1px solid var(--grid);text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.table th{color:var(--muted);font-weight:600;cursor:pointer;position:sticky;top:0;background:var(--panel)}

/* Inline stacked bar */
.rowbar{display:flex;height:16px;border-radius:6px;overflow:hidden;border:1px solid var(--grid)}
.rowbar .seg{height:100%}

/* Legends + swatches */
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.legend span{display:inline-flex;align-items:center;gap:6px;margin-right:12px;color:var(--muted);font-size:12px}
.swatch{width:10px;height:10px;border-radius:2px;display:inline-block}
.swatch.nd{background:var(--danger)}
.swatch.meets{background:var(--warn)}
.swatch.exceeds{background:var(--ok)}

/* Tooltip */
.tooltip{position:fixed;pointer-events:none;z-index:9999;background:#0f1520;border:1px solid var(--grid);color:var(--ink);padding:6px 8px;border-radius:8px;font-size:12px;box-shadow:0 4px 10px rgba(0,0,0,.35);display:none;white-space:nowrap}

/* Threshold legend */
.bandLegend{display:inline-flex;gap:10px;align-items:center}
.band{width:14px;height:10px;border-radius:2px;display:inline-block;border:1px solid var(--grid)}
.band.red{background:var(--band-red)}
.band.amber{background:var(--band-amber)}
.band.green{background:var(--band-green)}

/* Arrow colors (restored) */
.arr{font-weight:700;margin-right:4px}
.arr.up{color:var(--ok)} .arr.flat{color:var(--warn)} .arr.down{color:var(--danger)} .arr.na{color:var(--muted)}

/* Responsive */
@media (max-width:1200px){.kpis{grid-template-columns:repeat(3,1fr)}}
@media (max-width:700px){.kpis{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
  <div class="header">
    <h1>Calibration, Potential & Performance — Executive Dashboard <span class="badge">Prototype</span></h1>
    <div class="controls">
      <label class="small">Executive</label>
      <select id="execFilter"></select>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="calibration">Calibration Scorecard</div>
    <div class="tab" data-tab="potential">Potential & Outcomes</div>
    <div class="tab" data-tab="performance">Performance Scorecard</div>
  </div>

  <div class="container">
    <!-- CALIBRATION TAB -->
    <div id="tab-calibration">
      <div class="kpis"> 
        <div class="card"><h3>Avg Calibration Rate</h3><div class="val" id="k_calRate">–</div><div class="small">Share of employees adjusted via calibration</div></div>
        <div class="card"><h3>Post‑Cal: Needs Dev</h3><div class="val" id="k_needs">–</div><div class="small">Enterprise average distribution</div></div>
        <div class="card"><h3>Post‑Cal: Meets</h3><div class="val" id="k_meets">–</div><div class="small">Enterprise average distribution</div></div>
        <div class="card"><h3>Post‑Cal: Exceeds</h3><div class="val" id="k_exceeds">–</div><div class="small">Enterprise average distribution</div></div>
        <div class="card"><h3>Participation</h3><div class="val" id="k_participation">–</div><div class="small">% of employee review scores pulled into calibration out of all reviews assigned</div></div>
      </div>

      <div class="grid" style="margin-top:8px">
        <div class="section panel">
          <h3 class="sectionTitle">Calibration Distribution & Participation by Executive</h3>
          <table class="table" id="tblCal"><thead><tr>
            <th data-key="executive" data-type="str">Executive</th>
            <th data-key="post_needs" data-type="num">Needs Dev</th>
            <th data-key="post_meets" data-type="num">Meets</th>
            <th data-key="post_exceeds" data-type="num">Exceeds</th>
            <th>Distribution</th>
            <th data-key="calibration_rate" data-type="num">Calibration Rate</th>
            <th data-key="participation" data-type="num">Participation</th>
          </tr></thead><tbody></tbody></table>
          <div class="small" style="margin-top:8px;color:var(--muted)">Participation = % of employee review scores pulled into calibration out of all reviews assigned.</div>
        </div>
        <div class="section panel">
          <h3 class="sectionTitle">Post‑Calibration Distribution — Ridgeline View</h3>
          <div class="flex" style="justify-content:space-between; margin-bottom:6px">
            <div class="legend">
              <span><span class="swatch nd"></span> Needs Dev</span>
              <span><span class="swatch meets"></span> Meets</span>
              <span><span class="swatch exceeds"></span> Exceeds</span>
            </div>
            <div class="small">Hover any curve for exact %s</div>
          </div>
          <div id="ridgeHost" style="width:100%;height:520px;position:relative"></div>
        </div>
      </div>
    </div>

    <!-- POTENTIAL TAB -->
    <div id="tab-potential" style="display:none">
      <div class="kpis"></div>
      <div class="grid">
        <div class="section panel insights">
          <h3 class="sectionTitle">Highlights</h3>
          <ul id="insightsList"></ul>
          <div class="small">Note: Spreadsheet lacks explicit potential ratings; this prototype uses Post‑Cal distribution and outcome proxies.</div>
        </div>
        <div class="section panel">
          <h3 class="sectionTitle">Potential Snapshot by Executive</h3>
          <table class="table" id="tblPotential">
            <thead>
              <tr>
                <th data-key="executive" data-type="str">Executive</th>
                <th data-key="post_exceeds" data-type="num">Exceeds %</th>
                <th data-key="post_meets" data-type="num">Meets %</th>
                <th data-key="post_needs" data-type="num">Needs Dev %</th>
                <th data-key="low_perf" data-type="num">Low Performer Rate (2H)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PERFORMANCE TAB -->
    <div id="tab-performance" style="display:none">
      <div class="kpis">
        <div class="card">
          <h3>Avg PM Effectiveness</h3>
          <div class="val" id="k_pmEff">–</div>
          <div class="small">Involuntary terms <u>or</u> successful PIPs in prior period ÷ all low performers in prior period</div>
        </div>
        <div class="card"><h3>Avg PM Activity</h3><div class="val" id="k_pmAct">–</div><div class="small">% of PM actions taken vs. employees flagged</div></div>
        <div class="card"><h3>Avg PM Rate</h3><div class="val" id="k_pmRate">–</div><div class="small">% of headcount managed for performance</div></div>
        <div class="card"><h3>Avg Low Performers</h3><div class="val" id="k_lowPct">–</div><div class="small">% of headcount (sum of lows ÷ sum of HC)</div></div>
      </div>

      <div class="grid">
        <!-- 1) DETAILS TABLE WITH TREND ARROWS -->
        <div class="section panel">
          <h3 class="sectionTitle">Performance Management — Details by Executive</h3>
          <table class="table" id="tblPerformance">
            <thead>
              <tr>
                <th data-key="executive" data-type="str">Executive</th>
                <th data-key="pm_effectiveness" data-type="num">PM Effectiveness</th>
                <th data-key="pm_activity" data-type="num">PM Activity</th>
                <th data-key="pm_rate" data-type="num">PM Rate</th>
                <th data-key="low_pct" data-type="num">Low Performers (% of HC)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="small">Arrows show trend vs. 1H FY26: <span class="arr up">▲</span>= up (better), <span class="arr flat">►</span>= stable, <span class="arr down">▼</span>= down (worse).</div>
        </div>

        <!-- 2) EFFECTIVENESS + ACTIVITY COMBO WITH THRESHOLDS -->
        <div class="section panel">
          <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:6px">
            <h3 class="sectionTitle">Performance Management — Effectiveness & Activity</h3>
            <div class="flex" style="gap:18px">
              <span class="bandLegend">
                <span class="band red"></span><span class="small">Below 50%</span>
                <span class="band amber"></span><span class="small">50–75%</span>
                <span class="band green"></span><span class="small">≥ 75%</span>
              </span>
              <label class="small"><input type="checkbox" id="dualAxisToggle" /> Separate axis for Activity</label>
            </div>
          </div>
          <div id="perfCombo" class="combo" style="width:100%;height:460px"></div>
          <div class="small">Bars = Effectiveness; Line = Activity. Threshold bands: &lt;50 (red), 50–75 (amber), ≥75 (green).</div>
        </div>

        <!-- 3) PM RATE VS LOW PERFORMERS — VERTICAL -->
        <div class="section panel">
          <h3 class="sectionTitle">PM Rate vs Low Performers — By Executive (Vertical)</h3>
          <div id="rateLow" style="width:100%;height:480px"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Prototype generated from your spreadsheet. Filter to any executive to see their distribution and metrics.</footer>

<div class="tooltip" id="tooltip"></div>

<script>
/* ======= Embedded data (current period) ======= */
const DATA = {
  "executives":["Bar-Adon","Bowers","Constantine","Garrabrants (Commercial)","Matsumoto","Swanson","Thiele","Tolla","Watson"],
  "byExecutive":{
    "Bar-Adon":{"post_distribution":{"nd":0,"meets":1.0,"exceeds":0},"calibration_rate":0.0,"calibration_participation_rate":1.0,"perf":{"effectiveness":0.0,"activity":0.0,"rate":0.1111111111111111,"low_current":0,"headcount_prior":null}},
    "Bowers":{"post_distribution":{"nd":0,"meets":1.0,"exceeds":0},"calibration_rate":0.0,"calibration_participation_rate":1.0,"perf":{"effectiveness":0.0,"activity":0.0,"rate":0.0,"low_current":0,"headcount_prior":null}},
    "Constantine":{"post_distribution":{"nd":0.0,"meets":0.9166666666666666,"exceeds":0.08333333333333333},"calibration_rate":0.0625,"calibration_participation_rate":0.7868852459016393,"perf":{"effectiveness":0.7281553398058253,"activity":0.6666666666666666,"rate":0.02912621359223301,"low_current":0,"headcount_prior":null}},
    "Garrabrants (Commercial)":{"post_distribution":{"nd":0.04777070063694268,"meets":0.856687898089172,"exceeds":0.09554140127388536},"calibration_rate":0.1337579617834395,"calibration_participation_rate":0.7949367088607595,"perf":{"effectiveness":0.40404040404040403,"activity":0.4666666666666667,"rate":0.024242424242424242,"low_current":15,"headcount_prior":null}},
    "Matsumoto":{"post_distribution":{"nd":0.05576923076923077,"meets":0.8807692307692307,"exceeds":0.06346153846153846},"calibration_rate":0.019230769230769232,"calibration_participation_rate":0.994263862332696,"perf":{"effectiveness":0.5576208178438662,"activity":0.3793103448275862,"rate":0.033457249070631966,"low_current":29,"headcount_prior":null}},
    "Swanson":{"post_distribution":{"nd":0.09090909090909091,"meets":0.8712121212121212,"exceeds":0.03787878787878788},"calibration_rate":0.056818181818181816,"calibration_participation_rate":0.9072164948453608,"perf":{"effectiveness":0.3508771929824561,"activity":0.08333333333333333,"rate":0.045614035087719305,"low_current":24,"headcount_prior":null}},
    "Thiele":{"post_distribution":{"nd":0.029411764705882353,"meets":0.9215686274509803,"exceeds":0.049019607843137254},"calibration_rate":0.08823529411764706,"calibration_participation_rate":0.9714285714285714,"perf":{"effectiveness":0.7281553398058253,"activity":0.6666666666666666,"rate":0.02912621359223301,"low_current":3,"headcount_prior":null}},
    "Tolla":{"post_distribution":{"nd":0.034482758620689655,"meets":0.9655172413793104,"exceeds":0.0},"calibration_rate":0.09195402298850575,"calibration_participation_rate":1.0,"perf":{"effectiveness":0.4581901489117984,"activity":0.6666666666666666,"rate":0.041237113402061855,"low_current":3,"headcount_prior":null}},
    "Watson":{"post_distribution":{"nd":0.08571428571428572,"meets":0.9142857142857143,"exceeds":0.0},"calibration_rate":0.05714285714285714,"calibration_participation_rate":1.0,"perf":{"effectiveness":0.23809523809523808,"activity":0.6666666666666666,"rate":0.02857142857142857,"low_current":3,"headcount_prior":null}}
  },
  "aggregate":{"avg_calibration_rate":0.06280826519572183,"avg_participation":0.9298225979387794,"avg_post_nd":0.049282336149412626,"avg_post_meets":0.9202911638836794,"avg_post_exceeds":0.03042649996690785,"avg_pm_eff":0.3853489429525981,"avg_pm_act":0.48412716074018184,"avg_pm_rate":0.038506625778915525,"avg_low_pct_of_hc":null}
};

/* Prior period headcount override */
const HEADCOUNT_OVERRIDE = {
  "Bar-Adon":9, "Bowers":12, "Constantine":62, "Garrabrants (Commercial)":330,
  "Matsumoto":538, "Swanson":285, "Thiele":103, "Tolla":97, "Watson":35
};

/* Baseline for 1H FY26 to drive trend arrows */
const TREND_BASELINE = {
  "Bar-Adon": {"pm_effectiveness":0.00,"pm_activity":0.00,"pm_rate":0.00,"low_pct_of_hc":0.00},
  "Bowers": {"pm_effectiveness":0.00,"pm_activity":0.00,"pm_rate":0.00,"low_pct_of_hc":0.08},
  "Constantine": {"pm_effectiveness":0.75,"pm_activity":0.00,"pm_rate":0.04,"low_pct_of_hc":0.02},
  "Garrabrants (Commercial)": {"pm_effectiveness":0.71,"pm_activity":1.00,"pm_rate":0.05,"low_pct_of_hc":0.06},
  "Matsumoto": {"pm_effectiveness":0.43,"pm_activity":0.13,"pm_rate":0.04,"low_pct_of_hc":0.06},
  "Swanson": {"pm_effectiveness":0.13,"pm_activity":0.14,"pm_rate":0.01,"low_pct_of_hc":0.13},
  "Thiele": {"pm_effectiveness":0.57,"pm_activity":0.00,"pm_rate":0.02,"low_pct_of_hc":0.04},
  "Tolla": {"pm_effectiveness":0.20,"pm_activity":0.25,"pm_rate":0.02,"low_pct_of_hc":0.09},
  "Walsh": {"pm_effectiveness":0.06,"pm_activity":0.03,"pm_rate":0.01,"low_pct_of_hc":0.10},
  "Watson": {"pm_effectiveness":0.29,"pm_activity":0.20,"pm_rate":0.05,"low_pct_of_hc":0.12}
};
/* ============================
   Utility Functions
=============================*/
function pct(v){ if(v==null || isNaN(v)) return '–'; return (v*100).toFixed(1)+'%'; }
function fmt(val){ return val==null || isNaN(val) ? null : val; }

const execSel = document.getElementById('execFilter');
const resetBtn = document.getElementById('resetBtn');
execSel.innerHTML =
  '<option value="__all">All Executives</option>' +
  DATA.executives.map(e => `<option value="${e}">${e}</option>`).join('');


/* ============================
   Apply Headcount Overrides
=============================*/
(function applyHC(){
  let sumLow = 0, sumHC = 0;
  DATA.executives.forEach(e => {
    const rec = DATA.byExecutive[e];
    const p   = rec.perf || {};

    const hc = HEADCOUNT_OVERRIDE[e] ?? p.headcount_prior ?? null;
    p.headcount_prior = hc;

    const low = p.low_current;
    if(typeof hc === 'number' && typeof low === 'number'){
      sumLow += low;
      sumHC  += hc;
    }
    rec.perf = p;
  });
  DATA.aggregate.avg_low_pct_of_hc = sumHC ? (sumLow / sumHC) : null;
})();


/* ============================
   Flatten Performance Data
=============================*/
const PERF = {
  rows: DATA.executives.map(e => {
    const p = DATA.byExecutive[e].perf || {};
    const lowPct =
      (typeof p.low_current === 'number' &&
       typeof p.headcount_prior === 'number' &&
       p.headcount_prior > 0)
        ? (p.low_current / p.headcount_prior)
        : null;
    return {
      executive: e,
      pm_effectiveness: p.effectiveness ?? null,
      pm_activity:      p.activity ?? null,
      pm_rate:          p.rate ?? null,
      low_pct_of_hc:    lowPct
    };
  })
};


/* ============================
   Trend Arrow Logic (±2pp)
=============================*/
function deltaArrow(exec, key, cur){
  const base = TREND_BASELINE[exec]?.[key];
  if(base == null || isNaN(base) || cur == null || isNaN(cur))
    return '<span class="arr na">•</span>';

  const pp = (cur - base) * 100;
  if(pp >=  2) return '<span class="arr up">▲</span>';
  if(pp <= -2) return '<span class="arr down">▼</span>';
  return '<span class="arr flat">►</span>';
}


/* ============================
   Build Table Rows
=============================*/
function buildRows(filterExec){
  const tbodyCal  = document.querySelector('#tblCal tbody');
  const tbodyPot  = document.querySelector('#tblPotential tbody');
  const tbodyPerf = document.querySelector('#tblPerformance tbody');

  if(tbodyCal)  tbodyCal.innerHTML  = "";
  if(tbodyPot)  tbodyPot.innerHTML  = "";
  if(tbodyPerf) tbodyPerf.innerHTML = "";

  const rows = [];

  DATA.executives.forEach(e => {
    if(filterExec && filterExec !== "__all" && e !== filterExec) return;

    const rec  = DATA.byExecutive[e];
    const dist = rec.post_distribution;
    const p    = rec.perf || {};

    const lowPct =
      (typeof p.low_current === 'number' &&
       typeof p.headcount_prior === 'number' &&
       p.headcount_prior > 0)
        ? p.low_current / p.headcount_prior
        : null;

    rows.push({
      executive:        e,
      post_needs:       fmt(dist.nd),
      post_meets:       fmt(dist.meets),
      post_exceeds:     fmt(dist.exceeds),
      calibration_rate: fmt(rec.calibration_rate),
      participation:    fmt(rec.calibration_participation_rate),
      pm_effectiveness: fmt(p.effectiveness),
      pm_activity:      fmt(p.activity),
      pm_rate:          fmt(p.rate),
      low_pct:          fmt(lowPct)
    });
  });


  /* Populate Calibration Table */
  if(tbodyCal){
    rows.forEach(r => {
      const tr = document.createElement("tr");
      const distHTML = `
        <div class="rowbar"
             title="Needs Dev: ${pct(r.post_needs)} • Meets: ${pct(r.post_meets)} • Exceeds: ${pct(r.post_exceeds)}">
          <div class="seg" style="width:${(r.post_needs||0)*100}%;background:var(--danger)"></div>
          <div class="seg" style="width:${(r.post_meets||0)*100}%;background:var(--warn)"></div>
          <div class="seg" style="width:${(r.post_exceeds||0)*100}%;background:var(--ok)"></div>
        </div>
      `;
      tr.innerHTML = `
        <td style='white-space:nowrap'>${r.executive}</td>
        <td>${pct(r.post_needs)}</td>
        <td>${pct(r.post_meets)}</td>
        <td>${pct(r.post_exceeds)}</td>
        <td>${distHTML}</td>
        <td>${pct(r.calibration_rate)}</td>
        <td>${pct(r.participation)}</td>
      `;
      tbodyCal.appendChild(tr);
    });
  }

  /* Populate Potential Table */
  if(tbodyPot){
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.executive}</td>
        <td>${pct(r.post_exceeds)}</td>
        <td>${pct(r.post_meets)}</td>
        <td>${pct(r.post_needs)}</td>
        <td>–</td>
      `;
      tbodyPot.appendChild(tr);
    });
  }

  /* Populate Performance Table */
  if(tbodyPerf){
    rows.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.executive}</td>
        <td>${deltaArrow(r.executive,'pm_effectiveness',r.pm_effectiveness)}${pct(r.pm_effectiveness)}</td>
        <td>${deltaArrow(r.executive,'pm_activity',r.pm_activity)}${pct(r.pm_activity)}</td>
        <td>${deltaArrow(r.executive,'pm_rate',r.pm_rate)}${pct(r.pm_rate)}</td>
        <td>${deltaArrow(r.executive,'low_pct_of_hc',r.low_pct)}${pct(r.low_pct)}</td>
      `;
      tbodyPerf.appendChild(tr);
    });
  }
}


/* ============================
   KPI Calculations
=============================*/
function updateKPIs(filterExec){
  let rows = DATA.executives.map(e => DATA.byExecutive[e]);
  if(filterExec && filterExec !== "__all")
    rows = [DATA.byExecutive[filterExec]];

  const mean = (fn) => {
    const vals = rows.map(fn).filter(x => x != null && !isNaN(x));
    return vals.length ? vals.reduce((a,b)=>a+b,0) / vals.length : null;
  };

  document.getElementById("k_calRate").textContent      = pct(mean(r=>r.calibration_rate));
  document.getElementById("k_needs").textContent        = pct(mean(r=>(r.post_distribution||{}).nd));
  document.getElementById("k_meets").textContent        = pct(mean(r=>(r.post_distribution||{}).meets));
  document.getElementById("k_exceeds").textContent      = pct(mean(r=>(r.post_distribution||{}).exceeds));
  document.getElementById("k_participation").textContent= pct(mean(r=>r.calibration_participation_rate));
}

function updatePerfKPIs(){
  const agg = DATA.aggregate || {};
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v==null?'–':pct(v)); };
  set('k_pmEff',  agg.avg_pm_eff);
  set('k_pmAct',  agg.avg_pm_act);
  set('k_pmRate', agg.avg_pm_rate);
  set('k_lowPct', agg.avg_low_pct_of_hc);
}


/* ============================
   Make Tables Sortable
=============================*/
function makeSortable(tableId){
  const table = document.getElementById(tableId);
  if(!table) return;

  const ths = table.querySelectorAll('th[data-key]');
  ths.forEach(th => {
    th.addEventListener('click', () => {
      const idx  = Array.from(th.parentNode.children).indexOf(th);
      const type = th.dataset.type;
      const tbody= table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const asc  = th.classList.toggle('asc');

      rows.sort((a,b)=>{
        const strip = s => s.replace('%','').replace(/▲|▼|►|•/g,'');
        const av = strip(a.children[idx].innerText);
        const bv = strip(b.children[idx].innerText);
        if(type === 'num'){
          const an = parseFloat(av), bn = parseFloat(bv);
          return asc ? (an - bn) : (bn - an);
        } else {
          return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        }
      });
      rows.forEach(r=>tbody.appendChild(r));
    });
  });
}
/* ============================
   Tooltip helpers
=============================*/
const $tip = document.getElementById('tooltip');
function showTip(html, x, y){
  $tip.innerHTML = html;
  $tip.style.left = (x+12) + 'px';
  $tip.style.top  = (y+12) + 'px';
  $tip.style.display = 'block';
}
function moveTip(x, y){
  if($tip.style.display !== 'none'){
    $tip.style.left = (x+12) + 'px';
    $tip.style.top  = (y+12) + 'px';
  }
}
function hideTip(){ $tip.style.display = 'none'; }

/* Small helpers */
const fmtPct = v => (v==null||isNaN(v)) ? '–' : (v*100).toFixed(1)+'%';
function activeExecs(filterExec){
  const f = (filterExec ?? execSel.value);
  return (f && f!=='__all') ? [f] : DATA.executives.slice();
}

/* Optional: simple highlights on Potential tab */
function buildPotentialInsights(){
  const ul = document.getElementById('insightsList');
  if(!ul) return;
  const rows = DATA.executives.map(e=>{
    const d = DATA.byExecutive[e].post_distribution;
    return {e, ex:d.exceeds||0, nd:d.nd||0, me:d.meets||0};
  });
  const topEx = [...rows].sort((a,b)=>b.ex-a.ex)[0];
  const topND = [...rows].sort((a,b)=>b.nd-a.nd)[0];
  const nearBell = rows
    .map(r=>({e:r.e, diff: Math.abs((r.ex+r.nd) - 0.10)}))
    .sort((a,b)=>a.diff-b.diff)[0];

  ul.innerHTML = `
    <li><b>Highest “Exceeds” mix:</b> ${topEx ? `${topEx.e} (${fmtPct(topEx.ex)})` : '–'}</li>
    <li><b>Highest “Needs Dev” mix:</b> ${topND ? `${topND.e} (${fmtPct(topND.nd)})` : '–'}</li>
    <li><b>Closest to balanced curve:</b> ${nearBell ? `${nearBell.e}` : '–'}</li>
  `;
}

/* ============================
   Ridgeline Distribution Chart
=============================*/
function renderRidgeline(filterExec){
  const host = document.getElementById('ridgeHost');
  if(!host) return;
  host.innerHTML = '';

  const W = host.clientWidth || 960;
  const H = host.clientHeight || 520;
  const pad = {t:20,r:20,b:30,l:160};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;
  const svgNS = 'http://www.w3.org/2000/svg';

  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  host.appendChild(svg);

  const g = document.createElementNS(svgNS,'g');
  g.setAttribute('transform', `translate(${pad.l},${pad.t})`);
  svg.appendChild(g);

  let execs = activeExecs(filterExec);
  const band = innerH / (execs.length || 1);
  const X = v => v * innerW;
  const anchors = { nd:0.15, meets:0.5, ex:0.85 };

  // X grid + labels
  [0,0.25,0.5,0.75,1].forEach(t=>{
    const x = X(t);
    const ln = document.createElementNS(svgNS,'line');
    ln.setAttribute('x1',x); ln.setAttribute('x2',x);
    ln.setAttribute('y1',0); ln.setAttribute('y2',innerH);
    ln.setAttribute('stroke','var(--grid)');
    g.appendChild(ln);

    const lab = document.createElementNS(svgNS,'text');
    lab.setAttribute('x',x); lab.setAttribute('y',innerH+14);
    lab.setAttribute('fill','var(--muted)'); lab.setAttribute('font-size','11');
    lab.setAttribute('text-anchor','middle');
    lab.textContent = Math.round(t*100)+'%';
    g.appendChild(lab);
  });

  execs.forEach((name,i)=>{
    const dist = DATA.byExecutive[name].post_distribution || {};
    const nd = dist.nd??0, me = dist.meets??0, ex = dist.exceeds??0;
    const cy = i*band + band/2;

    // y-axis label
    const lbl = document.createElementNS(svgNS,'text');
    lbl.setAttribute('x', -10); lbl.setAttribute('y', cy+4);
    lbl.setAttribute('fill','var(--ink)'); lbl.setAttribute('font-size','12');
    lbl.setAttribute('text-anchor','end');
    lbl.textContent = name;
    g.appendChild(lbl);

    const ampMax = Math.max(nd, me, ex, 1e-6);
    const scaleY = v => (v/ampMax) * (band*0.7)/2;

    // simple curve points
    const pts = [
      {x:X(0.00), y:cy},
      {x:X(anchors.nd-0.10), y:cy},
      {x:X(anchors.nd),      y:cy - scaleY(nd)},
      {x:X((anchors.nd+anchors.meets)/2), y:cy - scaleY((nd+me)/2)},
      {x:X(anchors.meets),   y:cy - scaleY(me)},
      {x:X((anchors.meets+anchors.ex)/2), y:cy - scaleY((me+ex)/2)},
      {x:X(anchors.ex),      y:cy - scaleY(ex)},
      {x:X(anchors.ex+0.10), y:cy},
      {x:X(1.00),            y:cy}
    ];

    let d = 'M'+pts[0].x+' '+pts[0].y+' ';
    for(let k=1;k<pts.length;k++) d += 'L'+pts[k].x+' '+pts[k].y+' ';

    const path = document.createElementNS(svgNS,'path');
    path.setAttribute('d', d.trim());
    path.setAttribute('fill', 'rgba(77,182,255,0.12)');
    path.setAttribute('stroke','var(--accent)');
    path.setAttribute('stroke-width','1.5');
    g.appendChild(path);

    // Hover overlay across each executive band
    const overlay = document.createElementNS(svgNS,'rect');
    overlay.setAttribute('x', 0);
    overlay.setAttribute('y', cy - band/2);
    overlay.setAttribute('width', innerW);
    overlay.setAttribute('height', band);
    overlay.setAttribute('fill', 'transparent');
    overlay.addEventListener('mousemove', (ev)=>{
      showTip(
        `<b>${name}</b><br>Needs Dev: ${(nd*100).toFixed(1)}% • Meets: ${(me*100).toFixed(1)}% • Exceeds: ${(ex*100).toFixed(1)}%`,
        ev.pageX, ev.pageY
      );
    });
    overlay.addEventListener('mouseleave', hideTip);
    g.appendChild(overlay);
  });
}

/* ==========================================
   Performance Combo (Effectiveness + Activity)
   with Threshold Bands + Hover Tooltips
===========================================*/
function renderPerformance(filterExec){
  const host = document.getElementById('perfCombo');
  if(!host) return;
  host.innerHTML = '';

  let rows = PERF.rows.slice();
  const fx = (filterExec ?? execSel.value);
  if(fx && fx!=='__all') rows = rows.filter(r=>r.executive === fx);
  rows.sort((a,b)=>(b.pm_effectiveness||0)-(a.pm_effectiveness||0));

  const W = host.clientWidth || 960;
  const H = 460;
  const pad = {t:28,r:55,b:92,l:60};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;
  const svgNS = 'http://www.w3.org/2000/svg';

  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  host.appendChild(svg);

  const g = document.createElementNS(svgNS,'g');
  g.setAttribute('transform', `translate(${pad.l},${pad.t})`);
  svg.appendChild(g);

  const n = rows.length || 1;
  const band = innerW / n;
  const barW = Math.max(14, band*0.5);

  const dual = document.getElementById('dualAxisToggle')?.checked;
  const maxEff = Math.max(1e-6, ...rows.map(d=>d.pm_effectiveness||0));
  const maxAct = Math.max(1e-6, ...rows.map(d=>d.pm_activity||0));
  const maxBoth = Math.max(maxEff, maxAct);

  const yL = v => innerH - (v/(dual?maxEff:maxBoth))*innerH; // Effectiveness
  const yR = v => innerH - (v/(dual?maxAct:maxBoth))*innerH; // Activity
  const X  = i => i*band + band/2;

  // Threshold bands
  [
    {min:0.00, max:0.50, fill:'var(--band-red)'},
    {min:0.50, max:0.75, fill:'var(--band-amber)'},
    {min:0.75, max:1.00, fill:'var(--band-green)'}
  ].forEach(b=>{
    const y1 = yL(dual ? maxEff*b.max : b.max);
    const y2 = yL(dual ? maxEff*b.min : b.min);
    const rect = document.createElementNS(svgNS,'rect');
    rect.setAttribute('x', 0);
    rect.setAttribute('y', y1);
    rect.setAttribute('width', innerW);
    rect.setAttribute('height', Math.max(1, y2-y1));
    rect.setAttribute('fill', b.fill);
    g.appendChild(rect);
  });

  // Y grid
  [0,0.25,0.5,0.75,1].forEach(t=>{
    const y = innerH - t*innerH;
    const ln = document.createElementNS(svgNS,'line');
    ln.setAttribute('x1',0); ln.setAttribute('x2',innerW);
    ln.setAttribute('y1',y); ln.setAttribute('y2',y);
    ln.setAttribute('stroke','var(--grid)');
    g.appendChild(ln);
  });

  // Left axis labels
  [0,0.25,0.5,0.75,1].forEach(t=>{
    const y = yL(dual ? (t*maxEff) : t);
    const lab = document.createElementNS(svgNS,'text');
    lab.setAttribute('x',-10); lab.setAttribute('y',y+4);
    lab.setAttribute('fill','var(--muted)'); lab.setAttribute('font-size','11');
    lab.setAttribute('text-anchor','end');
    lab.textContent = Math.round(t*100)+'%';
    g.appendChild(lab);
  });

  // Right axis (if dual)
  if(dual){
    [0,0.25,0.5,0.75,1].forEach(t=>{
      const y = yR(t*maxAct);
      const lab = document.createElementNS(svgNS,'text');
      lab.setAttribute('x',innerW+10); lab.setAttribute('y',y+4);
      lab.setAttribute('fill','var(--muted)'); lab.setAttribute('font-size','11');
      lab.setAttribute('text-anchor','start');
      lab.textContent = Math.round(t*100)+'%';
      g.appendChild(lab);
    });
  }

  // X labels
  rows.forEach((d,i)=>{
    const cx = X(i);
    const lab = document.createElementNS(svgNS,'text');
    lab.setAttribute('x',cx); lab.setAttribute('y',innerH+16);
    lab.setAttribute('fill','var(--ink)'); lab.setAttribute('font-size','12');
    lab.setAttribute('text-anchor','middle');
    lab.textContent = d.executive;
    if(band < 90){ lab.setAttribute('transform', `translate(${cx},${innerH+16}) rotate(45)`); lab.setAttribute('text-anchor','start'); }
    g.appendChild(lab);
  });

  // Bars: Effectiveness (with hover)
  rows.forEach((d,i)=>{
    const cx = X(i);
    const y  = yL(d.pm_effectiveness||0);
    const h  = innerH - y;

    const rect = document.createElementNS(svgNS,'rect');
    rect.setAttribute('x', cx-barW/2);
    rect.setAttribute('y', y);
    rect.setAttribute('width', barW);
    rect.setAttribute('height', Math.max(1,h));
    rect.setAttribute('fill','var(--ok)');
    rect.style.cursor = 'pointer';
    rect.addEventListener('mouseenter', (ev)=>{
      showTip(
        `<b>${d.executive}</b><br>`+
        `Effectiveness: ${fmtPct(d.pm_effectiveness)}<br>`+
        `Activity: ${fmtPct(d.pm_activity)}<br>`+
        `PM Rate: ${fmtPct(d.pm_rate)}<br>`+
        `Low % of HC: ${fmtPct(d.low_pct_of_hc)}`,
        ev.pageX, ev.pageY
      );
    });
    rect.addEventListener('mousemove', (ev)=>moveTip(ev.pageX,ev.pageY));
    rect.addEventListener('mouseleave', hideTip);
    g.appendChild(rect);

    const tl = document.createElementNS(svgNS,'text');
    tl.setAttribute('x', cx);
    tl.setAttribute('y', Math.max(12, y-6));
    tl.setAttribute('fill','var(--muted)'); tl.setAttribute('font-size','11');
    tl.setAttribute('text-anchor','middle');
    tl.textContent = fmtPct(d.pm_effectiveness);
    g.appendChild(tl);
  });

  // Line: Activity + points (with hover)
  const path = document.createElementNS(svgNS,'path');
  let dAttr = '';
  rows.forEach((d,i)=>{
    const cx = X(i);
    const cy = yR(d.pm_activity||0);

    const c = document.createElementNS(svgNS,'circle');
    c.setAttribute('cx',cx); c.setAttribute('cy',cy);
    c.setAttribute('r',4);   c.setAttribute('fill','var(--accent)');
    c.style.cursor = 'pointer';
    c.addEventListener('mouseenter', (ev)=>{
      showTip(
        `<b>${d.executive}</b><br>`+
        `Activity: ${fmtPct(d.pm_activity)}<br>`+
        `Effectiveness: ${fmtPct(d.pm_effectiveness)}<br>`+
        `PM Rate: ${fmtPct(d.pm_rate)}<br>`+
        `Low % of HC: ${fmtPct(d.low_pct_of_hc)}`,
        ev.pageX, ev.pageY
      );
    });
    c.addEventListener('mousemove', (ev)=>moveTip(ev.pageX,ev.pageY));
    c.addEventListener('mouseleave', hideTip);
    g.appendChild(c);

    const tl = document.createElementNS(svgNS,'text');
    tl.setAttribute('x', cx);
    tl.setAttribute('y', cy-8);
    tl.setAttribute('fill','var(--muted)'); tl.setAttribute('font-size','11');
    tl.setAttribute('text-anchor','middle');
    tl.textContent = fmtPct(d.pm_activity);
    g.appendChild(tl);

    dAttr += (i===0 ? 'M' : 'L') + cx + ' ' + cy + ' ';
  });
  path.setAttribute('d', dAttr.trim());
  path.setAttribute('fill','none');
  path.setAttribute('stroke','var(--accent)');
  path.setAttribute('stroke-width','2');
  g.appendChild(path);

  // Also render the vertical PM Rate vs Low chart
  renderRateVsLowVertical(filterExec);
}

/* ==========================================
   Vertical PM Rate vs Low (% of HC) with Hover
===========================================*/
function renderRateVsLowVertical(filterExec){
  const host = document.getElementById('rateLow');
  if(!host) return;
  host.innerHTML = '';

  let rows = PERF.rows.slice();
  const fx = (filterExec ?? execSel.value);
  if(fx && fx!=='__all') rows = rows.filter(r=>r.executive===fx);

  const W = host.clientWidth || 960;
  const H = 420;
  const pad = {t:28,r:20,b:100,l:50};
  const innerW = W - pad.l - pad.r;
  const innerH = H - pad.t - pad.b;
  const svgNS = 'http://www.w3.org/2000/svg';

  const svg = document.createElementNS(svgNS,'svg');
  svg.setAttribute('width', W);
  svg.setAttribute('height', H);
  host.appendChild(svg);

  const g = document.createElementNS(svgNS,'g');
  g.setAttribute('transform', `translate(${pad.l},${pad.t})`);
  svg.appendChild(g);

  const n = rows.length || 1;
  const band = innerW / n;
  const barW = Math.max(12, band*0.4);

  const maxVal = Math.max(1e-6, ...rows.map(r=>Math.max(r.pm_rate||0, r.low_pct_of_hc||0)));
  const y = v => innerH - (v/maxVal) * innerH;
  const X = i => i*band + band/2;

  // grid + y labels
  [0,0.25,0.5,0.75,1].forEach(t=>{
    const yPos = y(t);
    const ln = document.createElementNS(svgNS,'line');
    ln.setAttribute('x1',0); ln.setAttribute('x2',innerW);
    ln.setAttribute('y1',yPos); ln.setAttribute('y2',yPos);
    ln.setAttribute('stroke','var(--grid)');
    g.appendChild(ln);

    const lab = document.createElementNS(svgNS,'text');
    lab.setAttribute('x',-10); lab.setAttribute('y',yPos+4);
    lab.setAttribute('fill','var(--muted)'); lab.setAttribute('font-size','11');
    lab.setAttribute('text-anchor','end');
    lab.textContent = Math.round(t*100)+'%';
    g.appendChild(lab);
  });

  // x labels
  rows.forEach((d,i)=>{
    const cx = X(i);
    const lab = document.createElementNS(svgNS,'text');
    lab.setAttribute('x',cx); lab.setAttribute('y',innerH+14);
    lab.setAttribute('fill','var(--ink)'); lab.setAttribute('font-size','12');
    lab.setAttribute('text-anchor','middle');
    lab.textContent = d.executive;
    if(band < 90){ lab.setAttribute('transform', `translate(${cx},${innerH+14}) rotate(45)`); lab.setAttribute('text-anchor','start'); }
    g.appendChild(lab);
  });

  // bars + hover
  rows.forEach((d,i)=>{
    const cx = X(i);

    // PM Rate
    const yRate = y(d.pm_rate||0);
    const hRate = innerH - yRate;
    const r1 = document.createElementNS(svgNS,'rect');
    r1.setAttribute('x', cx - barW*0.55);
    r1.setAttribute('y', yRate);
    r1.setAttribute('width',  barW*0.5);
    r1.setAttribute('height', Math.max(1,hRate));
    r1.setAttribute('fill', 'var(--accent)');
    r1.style.cursor = 'pointer';
    r1.addEventListener('mouseenter',(ev)=>{
      showTip(`<b>${d.executive}</b><br>PM Rate: ${fmtPct(d.pm_rate)}<br>Low % of HC: ${fmtPct(d.low_pct_of_hc)}`, ev.pageX, ev.pageY);
    });
    r1.addEventListener('mousemove',(ev)=>moveTip(ev.pageX,ev.pageY));
    r1.addEventListener('mouseleave', hideTip);
    g.appendChild(r1);

    // Low % of HC
    const yLow = y(d.low_pct_of_hc||0);
    const hLow = innerH - yLow;
    const r2 = document.createElementNS(svgNS,'rect');
    r2.setAttribute('x', cx + barW*0.05);
    r2.setAttribute('y', yLow);
    r2.setAttribute('width',  barW*0.5);
    r2.setAttribute('height', Math.max(1,hLow));
    r2.setAttribute('fill', 'var(--ok)');
    r2.style.cursor = 'pointer';
    r2.addEventListener('mouseenter',(ev)=>{
      showTip(`<b>${d.executive}</b><br>Low % of HC: ${fmtPct(d.low_pct_of_hc)}<br>PM Rate: ${fmtPct(d.pm_rate)}`, ev.pageX, ev.pageY);
    });
    r2.addEventListener('mousemove',(ev)=>moveTip(ev.pageX,ev.pageY));
    r2.addEventListener('mouseleave', hideTip);
    g.appendChild(r2);

    // data labels
    const t1 = document.createElementNS(svgNS,'text');
    t1.setAttribute('x', cx-barW*0.3);
    t1.setAttribute('y', yRate-6);
    t1.setAttribute('fill','var(--muted)'); t1.setAttribute('font-size','11');
    t1.setAttribute('text-anchor','middle');
    t1.textContent = fmtPct(d.pm_rate);
    g.appendChild(t1);

    const t2 = document.createElementNS(svgNS,'text');
    t2.setAttribute('x', cx+barW*0.3);
    t2.setAttribute('y', yLow-6);
    t2.setAttribute('fill','var(--muted)'); t2.setAttribute('font-size','11');
    t2.setAttribute('text-anchor','middle');
    t2.textContent = fmtPct(d.low_pct_of_hc);
    g.appendChild(t2);
  });

  // legend
  const legend = document.createElementNS(svgNS,'g');
  legend.setAttribute('transform', `translate(${pad.l},${pad.t-20})`);
  svg.appendChild(legend);

  function addL(x, color, label){
    const gL = document.createElementNS(svgNS,'g'); gL.setAttribute('transform',`translate(${x},0)`);
    const sw = document.createElementNS(svgNS,'rect'); sw.setAttribute('x',0); sw.setAttribute('y',0); sw.setAttribute('width',12); sw.setAttribute('height',12); sw.setAttribute('fill',color); sw.setAttribute('rx',2); gL.appendChild(sw);
    const tx = document.createElementNS(svgNS,'text'); tx.setAttribute('x',18); tx.setAttribute('y',11); tx.setAttribute('fill','var(--muted)'); tx.setAttribute('font-size','12'); tx.textContent = label; gL.appendChild(tx);
    legend.appendChild(gL);
  }
  addL(0,   'var(--accent)', 'PM Rate');
  addL(120, 'var(--ok)',     'Low Performers (% of HC)');
}

/* ============================
   Tabs, Filters, Initialization
=============================*/
function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');

  document.getElementById('tab-calibration').style.display = (name==='calibration') ? 'block':'none';
  document.getElementById('tab-potential').style.display   = (name==='potential')   ? 'block':'none';
  document.getElementById('tab-performance').style.display = (name==='performance') ? 'block':'none';

  if(name==='calibration')  renderRidgeline(execSel.value);
  if(name==='performance'){ updatePerfKPIs(); renderPerformance(execSel.value); }
  // Potential tab uses table + optional insights only.
}

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>showTab(t.dataset.tab));
});

execSel.addEventListener('change', ()=>{
  const tab = document.querySelector('.tab.active')?.dataset.tab;
  buildRows(execSel.value);
  updateKPIs(execSel.value);
  updatePerfKPIs();
  buildPotentialInsights();

  if(tab==='calibration')  renderRidgeline(execSel.value);
  if(tab==='performance')  renderPerformance(execSel.value);
});

resetBtn.addEventListener('click', ()=>{
  execSel.value='__all';
  buildRows('__all');
  updateKPIs('__all');
  updatePerfKPIs();
  buildPotentialInsights();
  renderRidgeline('__all');
  renderPerformance('__all');
});

document.getElementById('dualAxisToggle')?.addEventListener('change', ()=>{
  if(document.querySelector('.tab.active')?.dataset.tab==='performance'){
    renderPerformance(execSel.value);
  }
});

/* ============================
   Initial Render
=============================*/
buildRows('__all');
updateKPIs('__all');
updatePerfKPIs();
buildPotentialInsights();
makeSortable('tblCal');
makeSortable('tblPotential');
makeSortable('tblPerformance');
renderRidgeline('__all');
</script>
</body>
</html>